<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOP to BPMN Converter</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      padding: 1.5rem 2rem;
      text-align: center;
    }
    header h1 { font-size: 1.6rem; font-weight: 600; }
    header p { font-size: 0.9rem; color: #a0aec0; margin-top: 0.3rem; }

    .container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    /* Upload Card */
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      padding: 2rem;
      margin-bottom: 1.5rem;
    }
    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: #16213e;
    }

    /* Drop Zone */
    .drop-zone {
      border: 2px dashed #cbd5e0;
      border-radius: 10px;
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }
    .drop-zone:hover, .drop-zone.dragover {
      border-color: #4a6cf7;
      background: #f7f8ff;
    }
    .drop-zone svg {
      width: 48px; height: 48px; color: #a0aec0; margin-bottom: 0.8rem;
    }
    .drop-zone p { color: #718096; font-size: 0.95rem; }
    .drop-zone .browse { color: #4a6cf7; font-weight: 600; text-decoration: underline; cursor: pointer; }
    .drop-zone input[type="file"] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer;
    }

    .file-info {
      display: none;
      align-items: center;
      gap: 0.8rem;
      margin-top: 1rem;
      padding: 0.8rem 1rem;
      background: #f7f8ff;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .file-info.visible { display: flex; }
    .file-info .name { flex: 1; font-weight: 500; color: #1a1a2e; }
    .file-info .size { color: #718096; }
    .file-info .remove {
      background: none; border: none; color: #e53e3e; cursor: pointer;
      font-size: 1.1rem; padding: 0 0.3rem;
    }

    /* Convert Button */
    .btn-convert {
      display: block;
      width: 100%;
      margin-top: 1.2rem;
      padding: 0.9rem;
      background: linear-gradient(135deg, #4a6cf7 0%, #6c5ce7 100%);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
    }
    .btn-convert:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
    .btn-convert:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Progress */
    .progress-bar {
      display: none;
      margin-top: 1rem;
    }
    .progress-bar.visible { display: block; }
    .progress-track {
      height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; width: 0%; background: linear-gradient(90deg, #4a6cf7, #6c5ce7);
      border-radius: 3px; transition: width 0.3s;
    }
    .progress-text {
      font-size: 0.85rem; color: #718096; margin-top: 0.5rem; text-align: center;
    }

    /* Result Card */
    .result-card {
      display: none;
    }
    .result-card.visible { display: block; }

    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .result-header .status {
      display: flex; align-items: center; gap: 0.5rem;
      font-weight: 600; color: #38a169;
    }
    .result-header .status svg { width: 20px; height: 20px; }

    .btn-download {
      padding: 0.6rem 1.2rem;
      background: #38a169;
      color: #fff;
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      transition: opacity 0.2s;
    }
    .btn-download:hover { opacity: 0.85; }

    .xml-preview {
      background: #1a1a2e;
      color: #a0e8af;
      border-radius: 8px;
      padding: 1rem;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.8rem;
      line-height: 1.5;
      max-height: 400px;
      overflow: auto;
      white-space: pre;
      tab-size: 2;
    }

    /* Error */
    .error-msg {
      display: none;
      margin-top: 1rem;
      padding: 0.8rem 1rem;
      background: #fff5f5;
      border: 1px solid #feb2b2;
      border-radius: 8px;
      color: #c53030;
      font-size: 0.9rem;
    }
    .error-msg.visible { display: block; }

    /* Pipeline steps */
    .pipeline {
      display: flex;
      justify-content: center;
      gap: 0.3rem;
      margin: 1.5rem 0 0.5rem;
      flex-wrap: wrap;
    }
    .pipeline .step {
      font-size: 0.75rem;
      padding: 0.3rem 0.7rem;
      border-radius: 20px;
      background: #e2e8f0;
      color: #718096;
      transition: background 0.3s, color 0.3s;
    }
    .pipeline .step.active {
      background: #4a6cf7;
      color: #fff;
    }
    .pipeline .step.done {
      background: #38a169;
      color: #fff;
    }
    .pipeline .arrow {
      color: #cbd5e0;
      display: flex;
      align-items: center;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>

<header>
  <h1>SOP to BPMN Converter</h1>
  <p>Upload a .docx SOP file and get a BPMN 2.0 XML diagram</p>
</header>

<div class="container">
  <!-- Upload Card -->
  <div class="card">
    <h2>Upload SOP Document</h2>

    <div class="drop-zone" id="dropZone">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
      </svg>
      <p>Drag & drop your <strong>.docx</strong> file here, or <span class="browse">browse</span></p>
      <input type="file" id="fileInput" accept=".docx">
    </div>

    <div class="file-info" id="fileInfo">
      <span class="name" id="fileName"></span>
      <span class="size" id="fileSize"></span>
      <button class="remove" id="removeFile" title="Remove file">&times;</button>
    </div>

    <!-- Pipeline Steps -->
    <div class="pipeline" id="pipeline" style="display:none;">
      <span class="step" data-step="upload">Upload</span>
      <span class="arrow">&#8594;</span>
      <span class="step" data-step="parse">Parse .docx</span>
      <span class="arrow">&#8594;</span>
      <span class="step" data-step="llm">LLM Analysis</span>
      <span class="arrow">&#8594;</span>
      <span class="step" data-step="bpmn">Build BPMN</span>
      <span class="arrow">&#8594;</span>
      <span class="step" data-step="xml">Generate XML</span>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress-track">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">Converting...</div>
    </div>

    <div class="error-msg" id="errorMsg"></div>

    <button class="btn-convert" id="convertBtn" disabled>Convert to BPMN</button>
  </div>

  <!-- Result Card -->
  <div class="card result-card" id="resultCard">
    <div class="result-header">
      <div class="status">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Conversion Complete
      </div>
      <a class="btn-download" id="downloadBtn" download>Download .bpmn</a>
    </div>
    <h2>XML Preview</h2>
    <div class="xml-preview" id="xmlPreview"></div>
  </div>
</div>

<script>
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const fileInfo = document.getElementById('fileInfo');
  const fileName = document.getElementById('fileName');
  const fileSize = document.getElementById('fileSize');
  const removeFile = document.getElementById('removeFile');
  const convertBtn = document.getElementById('convertBtn');
  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const pipeline = document.getElementById('pipeline');
  const errorMsg = document.getElementById('errorMsg');
  const resultCard = document.getElementById('resultCard');
  const xmlPreview = document.getElementById('xmlPreview');
  const downloadBtn = document.getElementById('downloadBtn');

  let selectedFile = null;

  // Drag & drop
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) selectFile(file);
  });

  fileInput.addEventListener('change', () => {
    if (fileInput.files[0]) selectFile(fileInput.files[0]);
  });

  removeFile.addEventListener('click', () => {
    selectedFile = null;
    fileInput.value = '';
    fileInfo.classList.remove('visible');
    convertBtn.disabled = true;
    resultCard.classList.remove('visible');
    errorMsg.classList.remove('visible');
  });

  function selectFile(file) {
    if (!file.name.endsWith('.docx')) {
      showError('Please select a .docx file.');
      return;
    }
    selectedFile = file;
    fileName.textContent = file.name;
    fileSize.textContent = formatSize(file.size);
    fileInfo.classList.add('visible');
    convertBtn.disabled = false;
    errorMsg.classList.remove('visible');
    resultCard.classList.remove('visible');
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
  }

  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.classList.add('visible');
  }

  function setPipelineStep(stepName) {
    const steps = pipeline.querySelectorAll('.step');
    let found = false;
    steps.forEach(s => {
      if (s.dataset.step === stepName) {
        s.className = 'step active';
        found = true;
      } else if (!found) {
        s.className = 'step done';
      } else {
        s.className = 'step';
      }
    });
  }

  // Convert
  convertBtn.addEventListener('click', async () => {
    if (!selectedFile) return;

    convertBtn.disabled = true;
    errorMsg.classList.remove('visible');
    resultCard.classList.remove('visible');
    progressBar.classList.add('visible');
    pipeline.style.display = 'flex';

    // Animate pipeline steps
    const pipelineSteps = ['upload', 'parse', 'llm', 'bpmn', 'xml'];
    let stepIdx = 0;

    setPipelineStep(pipelineSteps[0]);
    progressFill.style.width = '10%';
    progressText.textContent = 'Uploading file...';

    const stepInterval = setInterval(() => {
      stepIdx++;
      if (stepIdx < pipelineSteps.length) {
        setPipelineStep(pipelineSteps[stepIdx]);
        progressFill.style.width = (10 + stepIdx * 20) + '%';
        const labels = ['Uploading file...', 'Parsing document...', 'Analyzing with LLM...', 'Building BPMN model...', 'Generating XML...'];
        progressText.textContent = labels[stepIdx];
      }
    }, 1500);

    try {
      const formData = new FormData();
      formData.append('file', selectedFile);

      const response = await fetch('/convert', { method: 'POST', body: formData });

      clearInterval(stepInterval);

      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.detail || 'Conversion failed');
      }

      const xmlText = await response.text();

      // Mark all done
      pipeline.querySelectorAll('.step').forEach(s => s.className = 'step done');
      progressFill.style.width = '100%';
      progressText.textContent = 'Done!';

      // Show result
      const bpmnFilename = selectedFile.name.replace('.docx', '.bpmn');
      const blob = new Blob([xmlText], { type: 'application/xml' });
      downloadBtn.href = URL.createObjectURL(blob);
      downloadBtn.download = bpmnFilename;

      xmlPreview.textContent = xmlText;
      resultCard.classList.add('visible');

      setTimeout(() => {
        progressBar.classList.remove('visible');
      }, 1000);

    } catch (err) {
      clearInterval(stepInterval);
      progressBar.classList.remove('visible');
      pipeline.style.display = 'none';
      showError(err.message);
    } finally {
      convertBtn.disabled = false;
    }
  });
</script>

</body>
</html>
